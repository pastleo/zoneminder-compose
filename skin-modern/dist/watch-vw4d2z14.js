import{a as y}from"/skins/modern/dist/main-vwq50fbr.js";import"/skins/modern/dist/main-xynt3e4r.js";import"/skins/modern/dist/main-3sctwwy9.js";var b=["Idle","Prealarm","Alarm","Alert","Tape"];class f{id;connKey;url;urlToZms;width;height;type;element=null;frame=null;streamCmdTimer=null;statusRefreshTimeout;lastAlarmState=0;lastPausedState=null;status=null;onPauseCallback=null;onPlayCallback=null;onAlarmCallback=null;onZoomChangeCallback=null;onAlarmStateChangeCallback=null;constructor(e){this.id=e.id,this.connKey=e.connKey,this.url=e.url,this.urlToZms=e.url_to_zms,this.width=e.width,this.height=e.height,this.type=e.type;let t=document.body.dataset.statusRefresh;this.statusRefreshTimeout=t?parseInt(t,10)*1000:5000}getElement(){if(this.element)return this.element;return this.element=document.getElementById(`liveStream${this.id}`),this.element}getFrame(){if(this.frame)return this.frame;return this.frame=document.getElementById(`imageFeed${this.id}`),this.frame}start(){let e=this.getElement();if(!e?.src){console.log(`[MonitorStream] No src for #liveStream${this.id}`);return}if(e.getAttribute("loading")==="lazy")e.setAttribute("loading","eager");let t=e.src.replace(/mode=single/i,"mode=jpeg");if(!t.includes("connkey"))t+=`&connkey=${this.connKey}`;if(e.src!==t)console.log(`[MonitorStream] Starting stream: ${t}`),e.src="",e.src=t;e.onerror=()=>this.onImageError(),e.onload=()=>this.onImageLoad()}onImageError(){if(console.log("[MonitorStream] Image stream error, stopping status polling"),this.streamCmdTimer)clearTimeout(this.streamCmdTimer),this.streamCmdTimer=null}onImageLoad(){if(!this.streamCmdTimer)console.log(`[MonitorStream] Image loaded, starting status polling for ${this.connKey}`),this.streamCmdTimer=setTimeout(()=>this.queryStatus(),this.statusRefreshTimeout)}stop(){if(this.sendCommand(3),this.streamCmdTimer)clearTimeout(this.streamCmdTimer),this.streamCmdTimer=null}pause(){this.sendCommand(1)}play(){this.sendCommand(2)}zoomOut(){this.sendCommand(9)}zoomIn(e,t){this.sendCommandWithParams(8,{x:e,y:t})}pan(e,t){this.sendCommandWithParams(10,{x:e,y:t})}getZoom(){return parseFloat(this.status?.zoom||"1")||1}fastForward(){this.sendCommand(4)}fastReverse(){this.sendCommand(7)}slowForward(){this.sendCommand(5)}slowReverse(){this.sendCommand(6)}async alarmCommand(e){let t=new URLSearchParams({view:"request",request:"alarm",id:String(this.id),command:e});try{let o=await(await fetch(`${this.url}?${t.toString()}`,{credentials:"include"})).text();console.log(`[MonitorStream] Alarm command '${e}' response:`,o)}catch(n){console.error("[MonitorStream] Alarm command failed:",n)}}enableAlarms(){return this.alarmCommand("enableAlarms")}disableAlarms(){return this.alarmCommand("disableAlarms")}forceAlarm(){return this.alarmCommand("forceAlarm")}cancelForcedAlarm(){return this.alarmCommand("cancelForcedAlarm")}isEnabled(){return this.status?.enabled??!0}isForced(){return this.status?.forced??!1}setScale(e){let t=this.getElement();if(!t?.src)return;let n=e;if(n>100)n=100;if(n<=0)n=100;let o=t.src,i=o.replace(/scale=\d+/i,`scale=${n}`);if(i!==o){if(this.streamCmdTimer)clearTimeout(this.streamCmdTimer),this.streamCmdTimer=null;if(o.includes("connkey")&&o.includes("mode=single"))this.sendCommand(17);console.log(`[MonitorStream] Changing scale to ${n}`),t.src="",t.src=i}}onPause(e){this.onPauseCallback=e}onPlay(e){this.onPlayCallback=e}onAlarm(e){this.onAlarmCallback=e}onZoomChange(e){this.onZoomChangeCallback=e}onAlarmStateChange(e){this.onAlarmStateChangeCallback=e}async sendCommand(e){this.sendCommandWithParams(e,{})}async sendCommandWithParams(e,t){let n=new URLSearchParams({view:"request",request:"stream",connkey:this.connKey,command:String(e)});for(let[o,i]of Object.entries(t))n.set(o,String(i));try{let i=await(await fetch(`${this.url}?${n.toString()}`,{credentials:"include"})).json();this.handleResponse(i)}catch(o){console.error("[MonitorStream] Command failed:",o)}}async queryStatus(){if(this.type==="WebSite")return;let e=new URLSearchParams({view:"request",request:"stream",connkey:this.connKey,command:String(99)});try{let n=await(await fetch(`${this.url}?${e.toString()}`,{credentials:"include"})).json();this.handleResponse(n)}catch(t){console.error("[MonitorStream] Status query failed:",t)}this.streamCmdTimer=setTimeout(()=>this.queryStatus(),this.statusRefreshTimeout)}handleResponse(e){if(e.result!=="Ok"||!e.status){if(e.message)console.error("[MonitorStream]",e.message);return}this.status=e.status,this.updateUI(),this.handleAlarmState(e.status.state)}updateUI(){if(!this.status)return;let e=(i)=>i.toLocaleString(void 0,{minimumFractionDigits:1,maximumFractionDigits:1});this.setText(`viewingFPSValue${this.id}`,e(this.status.fps)),this.setText(`captureFPSValue${this.id}`,e(this.status.capturefps)),this.setText(`analysisFPSValue${this.id}`,e(this.status.analysisfps)),this.setText(`stateValue${this.id}`,b[this.status.state]||"Unknown"),this.setText(`zoomValue${this.id}`,this.status.zoom),this.setText(`levelValue${this.id}`,String(this.status.level)),this.setText(`rateValue${this.id}`,String(this.status.rate)),this.setText(`delayValue${this.id}`,this.secsToTime(this.status.delay)),this.updateOverlayStatus(),this.onAlarmStateChangeCallback?.(this.status.enabled,this.status.forced);let t=this.status.paused,n=this.status.delayed;if(t)this.setText(`modeValue${this.id}`,"Paused");else if(n)this.setText(`modeValue${this.id}`,"Replay");else this.setText(`modeValue${this.id}`,"Live");if(this.lastPausedState!==t){if(t)this.onPauseCallback?.();else if(this.lastPausedState!==null)this.onPlayCallback?.();this.lastPausedState=t}let o=document.getElementById(`stateValue${this.id}`);if(o)if(o.className="badge",this.status.state===2)o.classList.add("badge-error");else if(this.status.state===3)o.classList.add("badge-warning");else o.classList.add("badge-info")}setText(e,t){let n=document.getElementById(e);if(n)n.textContent=t}secsToTime(e){let t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);if(t>0)return`${t}:${String(n).padStart(2,"0")}:${String(o).padStart(2,"0")}`;return`${n}:${String(o).padStart(2,"0")}`}updateOverlayStatus(){if(!this.status)return;let e=parseFloat(this.status.zoom)||1,t=document.getElementById("overlayZoom"),n=document.getElementById("overlayZoomValue");if(t&&n)n.textContent=String(e),t.classList.toggle("hidden",e<=1);this.onZoomChangeCallback?.(e);let o=this.status.rate||1,i=document.getElementById("overlayRate"),l=document.getElementById("overlayRateValue");if(i&&l)l.textContent=String(o),i.classList.toggle("hidden",o===1);let d=this.status.delay||0,c=document.getElementById("overlayDelay"),u=document.getElementById("overlayDelayValue");if(c&&u)u.textContent=this.secsToTime(d),c.classList.toggle("hidden",d===0);let a=this.status.level||0,r=document.getElementById("bufferProgress");if(r)r.style.width=`${a}%`}handleAlarmState(e){let t=e===2||e===3,n=this.lastAlarmState===2||this.lastAlarmState===3,o=t&&!n,i=!t&&n,l=document.getElementById(`monitor${this.id}`);if(l)if(l.classList.remove("alarm","alert","idle"),e===2)l.classList.add("alarm");else if(e===3)l.classList.add("alert");else l.classList.add("idle");if(o||i){this.onAlarmCallback?.();let d=document.getElementById("alarmSound");if(d)d.classList.toggle("hidden",!o)}this.lastAlarmState=e}destroy(){if(this.streamCmdTimer)clearTimeout(this.streamCmdTimer),this.streamCmdTimer=null;let e=this.getElement();if(e)e.onerror=null,e.onload=null}}var I=3000,s=null,v=null,m=null,g=!0;function D(){T(),w(),R(),F(),P()}function E(){let e=document.body;return{id:parseInt(e.dataset.monitorId||"0",10),connKey:e.dataset.connkey||"",url:e.dataset.monitorUrl||window.location.pathname,url_to_zms:"/cgi-bin/nph-zms",width:parseInt(e.dataset.monitorWidth||"640",10),height:parseInt(e.dataset.monitorHeight||"480",10),type:e.dataset.monitorType||"Local"}}function T(){let e=E();if(!e.id||!e.connKey){console.log("[watch] Missing monitor data, stream controls disabled");return}s=new f(e),s.onPause(()=>{h(!1)}),s.onPlay(()=>{h(!0)}),s.onAlarm(()=>{v?.load()}),s.start()}function w(){let e=E();if(!e.id)return;v=new y({containerId:"events",monitorId:e.id,limit:24,showCheckboxes:!0,showPagination:!0,onSelectionChange:M}),v.load(),window.refreshEventCards=()=>v?.load()}function M(e){let t=e.size>0,n=document.getElementById("eventsArchiveBtn"),o=document.getElementById("eventsUnarchiveBtn"),i=document.getElementById("eventsExportBtn"),l=document.getElementById("eventsDeleteBtn");if(n)n.disabled=!t;if(o)o.disabled=!t;if(i)i.disabled=!t;if(l)l.disabled=!t}function F(){let e=document.getElementById("videoOverlay"),t=e?.closest(".monitor");if(!e||!t)return;let o=document.body.dataset.streamReplayBuffer!=="0";if(p(e,t),H(),A(t),o)C()}function p(e,t){let n=()=>{e.classList.remove("opacity-0"),e.classList.add("opacity-100"),L(e)},o=()=>{e.classList.remove("opacity-100"),e.classList.add("opacity-0")};t.addEventListener("mousemove",n),t.addEventListener("mouseenter",n),t.addEventListener("mouseleave",o),t.addEventListener("touchstart",()=>{n(),L(e)},{passive:!0}),e.addEventListener("click",(i)=>{if(i.target===e)B()})}function L(e){if(m)clearTimeout(m);m=setTimeout(()=>{e.classList.remove("opacity-100"),e.classList.add("opacity-0")},I)}function H(){document.getElementById("overlayPlayPauseBtn")?.addEventListener("click",B),document.getElementById(`imageFeed${E().id}`)?.addEventListener("click",(n)=>{if(n.target.closest("button, a"))return;B()})}function B(){if(g)s?.pause();else s?.play()}function h(e){g=e;let t=document.getElementById("overlayPlayIcon"),n=document.getElementById("overlayPauseIcon");if(e)t?.classList.add("hidden"),n?.classList.remove("hidden");else t?.classList.remove("hidden"),n?.classList.add("hidden")}function A(e){let t=document.getElementById("overlayFullscreenBtn"),n=document.getElementById("overlayEnterFsIcon"),o=document.getElementById("overlayExitFsIcon");t?.addEventListener("click",async()=>{try{if(document.fullscreenElement)await document.exitFullscreen();else await e.requestFullscreen()}catch(i){console.error("[watch] Fullscreen error:",i)}}),document.addEventListener("fullscreenchange",()=>{let i=!!document.fullscreenElement;n?.classList.toggle("hidden",i),o?.classList.toggle("hidden",!i)})}function C(){document.getElementById("overlayFastRevBtn")?.addEventListener("click",()=>s?.fastReverse()),document.getElementById("overlaySlowRevBtn")?.addEventListener("click",()=>s?.slowReverse()),document.getElementById("overlaySlowFwdBtn")?.addEventListener("click",()=>s?.slowForward()),document.getElementById("overlayFastFwdBtn")?.addEventListener("click",()=>s?.fastForward())}function R(){let e=document.getElementById("backBtn");if(e)e.disabled=!document.referrer.length,e.addEventListener("click",(n)=>{n.preventDefault(),window.history.back()});document.getElementById("refreshBtn")?.addEventListener("click",(n)=>{n.preventDefault(),window.location.reload()})}function P(){if(document.body.dataset.canEditMonitors!=="1"||!s)return;let n=document.getElementById("enableAlmBtn"),o=document.getElementById("forceAlmBtn"),i=document.getElementById("enableAlmBtnText"),l=document.getElementById("forceAlmBtnText");if(!n||!o)return;let d=!0,c=!1,u=(a,r)=>{if(d=a,c=r,n.disabled=!1,a){if(n.classList.remove("btn-primary"),n.classList.add("btn-ghost"),n.title="Disable Alarms",i)i.textContent="Disable";if(o.disabled=!1,r){if(o.classList.remove("btn-error"),o.classList.add("btn-warning"),o.title="Cancel Forced Alarm",l)l.textContent="Cancel Force"}else if(o.classList.remove("btn-warning"),o.classList.add("btn-error"),o.title="Force Alarm",l)l.textContent="Force"}else{if(n.classList.remove("btn-ghost"),n.classList.add("btn-primary"),n.title="Enable Alarms",i)i.textContent="Enable";o.disabled=!0,o.title="Force Alarm (alarms disabled)"}};s.onAlarmStateChange(u),n.addEventListener("click",async()=>{if(n.disabled=!0,d)await s?.disableAlarms();else await s?.enableAlarms()}),o.addEventListener("click",async()=>{if(o.disabled=!0,c)await s?.cancelForcedAlarm();else await s?.forceAlarm()})}export{D as init};
