import{b as N,c as w,d as C,e as F}from"/skins/modern/dist/main-xynt3e4r.js";import"/skins/modern/dist/main-3sctwwy9.js";var Z=[25,50,100,150,200,400,800,1600];class K{config;eventData=null;nearEvents=null;frames=[];videoElement=null;mjpegElement=null;isPaused=!1;currentRate=100;currentZoom=1;currentProgress=0;streamCmdTimer=null;reverseInterval=null;onPlayCallback=null;onPauseCallback=null;onProgressCallback=null;onRateChangeCallback=null;onZoomChangeCallback=null;onEventLoadCallback=null;onNearEventsCallback=null;onFramesCallback=null;onEndCallback=null;constructor(q){this.config=q,this.currentRate=q.initialRate||100}async init(){if(await this.loadEventData(),await this.loadNearEvents(),await this.loadFrames(),this.config.mode==="video")this.initVideoElement();else this.initMjpegElement()}initVideoElement(){if(this.videoElement=document.getElementById("videoPlayer"),!this.videoElement){console.error("[EventStream] Video element #videoPlayer not found");return}if(this.videoElement.addEventListener("play",()=>{this.isPaused=!1,this.stopReversePlayback(),this.onPlayCallback?.()}),this.videoElement.addEventListener("pause",()=>{this.isPaused=!0,this.onPauseCallback?.()}),this.videoElement.addEventListener("timeupdate",()=>{this.currentProgress=this.videoElement.currentTime,this.onProgressCallback?.(this.currentProgress,this.getDuration())}),this.videoElement.addEventListener("ratechange",()=>{this.currentRate=Math.round(this.videoElement.playbackRate*100),this.onRateChangeCallback?.(this.currentRate)}),this.videoElement.addEventListener("ended",()=>{this.onEndCallback?.()}),this.currentRate>0&&this.currentRate!==100)this.videoElement.playbackRate=this.currentRate/100}initMjpegElement(){if(this.mjpegElement=document.getElementById("evtStream"),!this.mjpegElement){console.error("[EventStream] MJPEG element #evtStream not found");return}this.startStatusPolling()}async loadEventData(){try{let q=new URLSearchParams({view:"request",request:"status",entity:"event",id:String(this.config.eventId)}),J=await(await fetch(`?${q.toString()}`,{credentials:"include"})).json();if(J.event){if(this.eventData=J.event,this.eventData)this.onEventLoadCallback?.(this.eventData)}}catch(q){console.error("[EventStream] Failed to load event data:",q)}}async loadNearEvents(){try{let q=`?view=request&request=status&entity=nearevents&id=${this.config.eventId}`;if(this.config.filterQuery)q+=this.config.filterQuery;if(this.config.sortQuery)q+=this.config.sortQuery;let J=await(await fetch(q,{credentials:"include"})).json();if(J.nearevents){if(this.nearEvents=J.nearevents,this.nearEvents)this.onNearEventsCallback?.(this.nearEvents)}}catch(q){console.error("[EventStream] Failed to load near events:",q)}}async loadFrames(){try{let q=new URLSearchParams({view:"request",request:"status",entity:"frames",id:String(this.config.eventId)}),J=await(await fetch(`?${q.toString()}`,{credentials:"include"})).json();if(J.frames)this.frames=J.frames,this.onFramesCallback?.(this.frames)}catch(q){console.error("[EventStream] Failed to load frames:",q)}}play(){if(this.config.mode==="video"&&this.videoElement)this.stopReversePlayback(),this.videoElement.play();else this.sendCommand(2);this.isPaused=!1,this.onPlayCallback?.()}pause(){if(this.config.mode==="video"&&this.videoElement)this.stopReversePlayback(),this.videoElement.pause();else this.sendCommand(1);this.isPaused=!0,this.onPauseCallback?.()}togglePlayPause(){if(this.isPaused)this.play();else this.pause()}setRate(q){if(this.currentRate=q,this.config.mode==="video"&&this.videoElement){if(q<=0)this.videoElement.pause(),this.startReversePlayback(Math.abs(q)/100);else if(this.stopReversePlayback(),this.videoElement.playbackRate=q/100,this.isPaused)this.videoElement.play()}else this.sendCommand(15,{rate:q});this.onRateChangeCallback?.(q)}startReversePlayback(q){if(this.stopReversePlayback(),!this.videoElement)return;let z=500,J=q*(z/1000);this.reverseInterval=setInterval(()=>{if(!this.videoElement)return;let O=this.videoElement.currentTime-J;if(O<=0)this.videoElement.currentTime=0,this.stopReversePlayback(),this.pause();else this.videoElement.currentTime=O},z)}stopReversePlayback(){if(this.reverseInterval)clearInterval(this.reverseInterval),this.reverseInterval=null}fastForward(){let q=Z.indexOf(this.currentRate),z=Math.min(q+1,Z.length-1),J=Z[z];if(J!==void 0)this.setRate(J)}fastReverse(){if(this.config.mode==="video"){let q=Math.abs(this.currentRate),z=Z.indexOf(q),J=z>0?z-1:0,O=Z[J];if(O!==void 0)this.setRate(-O)}else this.sendCommand(7)}stepForward(){if(this.config.mode==="video"&&this.videoElement){this.videoElement.pause();let q=this.getDuration(),z=q/(this.eventData?.Frames||100);this.videoElement.currentTime=Math.min(this.videoElement.currentTime+z,q)}else this.sendCommand(5)}stepBackward(){if(this.config.mode==="video"&&this.videoElement){this.videoElement.pause();let z=this.getDuration()/(this.eventData?.Frames||100);this.videoElement.currentTime=Math.max(this.videoElement.currentTime-z,0)}else this.sendCommand(6)}seek(q){if(this.config.mode==="video"&&this.videoElement)this.videoElement.currentTime=q;else this.sendCommand(14,{offset:q});this.currentProgress=q,this.onProgressCallback?.(q,this.getDuration())}seekPercent(q){let z=this.getDuration();this.seek(q/100*z)}zoomIn(q,z){if(this.config.mode==="video")this.currentZoom=Math.min(this.currentZoom+0.5,4),this.applyVideoZoom();else{let J={};if(q!==void 0)J.x=q;if(z!==void 0)J.y=z;this.sendCommand(8,J)}this.onZoomChangeCallback?.(this.currentZoom)}zoomOut(){if(this.config.mode==="video")this.currentZoom=Math.max(this.currentZoom-0.5,1),this.applyVideoZoom();else this.sendCommand(9);this.onZoomChangeCallback?.(this.currentZoom)}applyVideoZoom(){if(!this.videoElement)return;this.videoElement.style.transform=`scale(${this.currentZoom})`}hasPrev(){return(this.nearEvents?.PrevEventId??0)>0}hasNext(){return(this.nearEvents?.NextEventId??0)>0}getPrevEventId(){return this.nearEvents?.PrevEventId??0}getNextEventId(){return this.nearEvents?.NextEventId??0}navigatePrev(){if(!this.hasPrev())return;this.navigateToEvent(this.nearEvents.PrevEventId)}navigateNext(){if(!this.hasNext())return;this.navigateToEvent(this.nearEvents.NextEventId)}navigateToEvent(q){let z=`?view=event&eid=${q}`;if(this.config.filterQuery)z+=this.config.filterQuery;if(this.config.sortQuery)z+=this.config.sortQuery;window.location.href=z}async sendCommand(q,z={}){let J=new URLSearchParams({view:"request",request:"stream",connkey:this.config.connKey,command:String(q)});for(let[O,U]of Object.entries(z))J.set(O,String(U));try{let U=await(await fetch(`?${J.toString()}`,{credentials:"include"})).json();this.handleStreamResponse(U)}catch(O){console.error("[EventStream] Command failed:",O)}}handleStreamResponse(q){if(q.result!=="Ok"||!q.status){if(q.message)console.error("[EventStream]",q.message);return}let z=q.status;if(this.currentProgress=z.progress,this.currentRate=z.rate*100,this.currentZoom=parseFloat(z.zoom)||1,this.isPaused=z.paused,z.duration&&this.eventData)this.eventData.Length=z.duration;if(this.onProgressCallback?.(this.currentProgress,this.getDuration()),this.onRateChangeCallback?.(this.currentRate),this.onZoomChangeCallback?.(this.currentZoom),z.paused)this.onPauseCallback?.();else this.onPlayCallback?.()}startStatusPolling(){if(this.streamCmdTimer)return;let q=async()=>{await this.sendCommand(99),this.streamCmdTimer=setTimeout(q,1000)};this.streamCmdTimer=setTimeout(q,500)}getEventData(){return this.eventData}getNearEvents(){return this.nearEvents}getFrames(){return this.frames}getDuration(){if(this.config.mode==="video"&&this.videoElement)return this.videoElement.duration||this.eventData?.Length||0;return this.eventData?.Length||0}getProgress(){return this.currentProgress}getRate(){return this.currentRate}getZoom(){return this.currentZoom}isPausedState(){return this.isPaused}isVideoMode(){return this.config.mode==="video"}onPlay(q){this.onPlayCallback=q}onPause(q){this.onPauseCallback=q}onProgress(q){this.onProgressCallback=q}onRateChange(q){this.onRateChangeCallback=q}onZoomChange(q){this.onZoomChangeCallback=q}onEventLoad(q){this.onEventLoadCallback=q}onNearEvents(q){this.onNearEventsCallback=q}onFrames(q){this.onFramesCallback=q}onEnd(q){this.onEndCallback=q}destroy(){if(this.stopReversePlayback(),this.streamCmdTimer)clearTimeout(this.streamCmdTimer),this.streamCmdTimer=null;if(this.config.mode==="mjpeg")this.sendCommand(17)}}function L(){let q=document.body,z=parseInt(q.dataset.eventId||"0",10),J=parseInt(q.dataset.monitorId||"0",10),O=q.dataset.connkey||"",U=q.dataset.streamMode==="video"?"video":"mjpeg";if(!z)return null;return{eventId:z,monitorId:J,connKey:O,mode:U,videoSrc:q.dataset.videoSrc,mjpegSrc:q.dataset.mjpegSrc,initialRate:parseInt(q.dataset.rate||"100",10),initialScale:parseInt(q.dataset.scale||"100",10),filterQuery:q.dataset.filterQuery,sortQuery:q.dataset.sortQuery}}function V(q){if(!isFinite(q))return"0:00";let z=Math.floor(q/3600),J=Math.floor(q%3600/60),O=Math.floor(q%60);if(z>0)return`${z}:${String(J).padStart(2,"0")}:${String(O).padStart(2,"0")}`;return`${J}:${String(O).padStart(2,"0")}`}var W=null;function m(){let q=L();if(!q){console.log("[event] No event config found");return}W=new K(q),W.onPlay(E),W.onPause(P),W.onProgress(R),W.onRateChange(D),W.onNearEvents(B),W.onFrames(T),W.onEnd(x),W.init(),y(),k(),u(),p(),S()}function E(){let q=document.getElementById("playIcon"),z=document.getElementById("pauseIcon");q?.classList.add("hidden"),z?.classList.remove("hidden"),j("modeValue","Playing")}function P(){let q=document.getElementById("playIcon"),z=document.getElementById("pauseIcon");q?.classList.remove("hidden"),z?.classList.add("hidden"),j("modeValue","Paused")}function R(q,z){j("currentTime",V(q)),j("totalTime",V(z)),j("progressValue",V(q));let J=document.getElementById("progressFill");if(J&&z>0){let O=q/z*100;J.style.width=`${O}%`}}function D(q){let z=document.getElementById("rate");if(z)z.value=String(q)}function B(q){let z=document.getElementById("prevBtn"),J=document.getElementById("nextBtn");if(z)z.disabled=q.PrevEventId===0;if(J)J.disabled=q.NextEventId===0}function T(q){A(q)}function x(){let q=document.body;switch(document.getElementById("replayMode")?.value||"none"){case"single":W?.seek(0),W?.play();break;case"all":case"gapless":if(W?.hasNext())W.navigateNext();break}}function A(q){let z=document.getElementById("alarmCue");if(!z||!q.length)return;let J=q[q.length-1];if(!J)return;let O=J.Delta||1,U="",Q=!1,$=0;for(let X of q){let G=X.Type==="Alarm";if(G&&!Q){let H=(X.Delta-$)/O*100;if(H>0)U+=`<span class="bg-transparent" style="width:${H}%"></span>`;$=X.Delta,Q=!0}else if(!G&&Q){let H=(X.Delta-$)/O*100;U+=`<span class="bg-error" style="width:${H}%"></span>`,$=X.Delta,Q=!1}}if(Q){let X=(O-$)/O*100;U+=`<span class="bg-error" style="width:${X}%"></span>`}else{let X=(O-$)/O*100;if(X>0)U+=`<span class="bg-transparent" style="width:${X}%"></span>`}z.innerHTML=U}function y(){document.getElementById("playPauseBtn")?.addEventListener("click",()=>{W?.togglePlayPause()}),document.getElementById("stepRevBtn")?.addEventListener("click",()=>{W?.stepBackward()}),document.getElementById("stepFwdBtn")?.addEventListener("click",()=>{W?.stepForward()}),document.getElementById("prevBtn")?.addEventListener("click",()=>{W?.navigatePrev()}),document.getElementById("nextBtn")?.addEventListener("click",()=>{W?.navigateNext()});let q=document.getElementById("videoPlayer"),z=document.getElementById("imageFeed");(q||z)?.addEventListener("click",(O)=>{if(O.target.closest("button, a"))return;W?.togglePlayPause()})}function k(){document.getElementById("editBtn")?.addEventListener("click",b),document.getElementById("renameBtn")?.addEventListener("click",I),document.getElementById("archiveBtn")?.addEventListener("click",()=>M(!0)),document.getElementById("unarchiveBtn")?.addEventListener("click",()=>M(!1)),document.getElementById("videoBtn")?.addEventListener("click",f),document.getElementById("deleteBtn")?.addEventListener("click",h)}async function I(){let q=document.getElementById("eventName")?.textContent||"",z=prompt("Enter new name:",q);if(z&&z!==q){let J=document.body.dataset.eventId;try{if((await(await fetch(`?view=request&request=event&action=rename&id=${J}&eventName=${encodeURIComponent(z)}`,{credentials:"include"})).json()).result==="Ok")document.getElementById("eventName").textContent=z}catch(O){console.error("[event] Rename failed:",O)}}}async function M(q){let z=document.body.dataset.eventId,J=q?"archive":"unarchive";try{await fetch(`?request=events&task=${J}&eids[]=${z}`,{credentials:"include"}),window.location.reload()}catch(O){console.error(`[event] ${J} failed:`,O)}}async function h(){if(!await F("Are you sure you want to delete this event?","Delete Event"))return;let z=document.body.dataset.eventId;try{if(W?.pause(),await fetch(`?request=event&action=delete&id=${z}`,{credentials:"include"}),W?.hasNext())W.navigateNext();else if(W?.hasPrev())W.navigatePrev();else window.history.back()}catch(J){console.error("[event] Delete failed:",J)}}async function b(){let q=document.body.dataset.eventId;if(!q)return;try{let J=await(await fetch(`?view=request&request=status&entity=event&id=${q}`,{credentials:"include"})).json();if(!J.event){console.error("[event] Failed to fetch event data");return}let O=J.event;N({id:"edit-event-modal",title:`Event ${q}`,content:`
        <form id="editEventForm" class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">${Y("Cause")}</span>
            </label>
            <input type="text" name="cause" class="input input-bordered w-full" value="${_(O.Cause||"")}" />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text">${Y("Notes")}</span>
            </label>
            <textarea name="notes" class="textarea textarea-bordered w-full h-32">${_(O.Notes||"")}</textarea>
          </div>
        </form>
      `,actions:[{label:Y("Cancel"),className:"btn btn-ghost"},{label:Y("Save"),className:"btn btn-primary",closeOnClick:!1,onClick:async(U,Q)=>{let $=Q.querySelector("#editEventForm"),X=$.querySelector('[name="cause"]').value,G=$.querySelector('[name="notes"]').value;await g(q,X,G),C("edit-event-modal"),window.location.reload()}}]}),w("edit-event-modal")}catch(z){console.error("[event] Edit failed:",z)}}async function g(q,z,J){let O=window.csrfMagicToken||"",U=new FormData;U.append("__csrf_magic",O),U.append("view","eventdetail"),U.append("action","eventdetail"),U.append("markEids[]",q),U.append("newEvent[Cause]",z),U.append("newEvent[Notes]",J),await fetch("?view=eventdetail&action=eventdetail",{method:"POST",credentials:"include",body:U})}function Y(q){return{Cause:"Cause",Notes:"Notes",Cancel:"Cancel",Save:"Save"}[q]||q}function _(q){let z=document.createElement("div");return z.textContent=q,z.innerHTML}function f(){let q=document.body.dataset.eventId;window.location.assign(`?view=video&eid=${q}`)}function u(){let q=document.getElementById("codec");q?.addEventListener("change",()=>{let O=new URL(window.location.href);O.searchParams.set("codec",q.value),window.location.href=O.toString()});let z=document.getElementById("replayMode");z?.addEventListener("change",()=>{document.cookie=`replayMode=${z.value};path=/;max-age=3600`});let J=document.getElementById("rate");J?.addEventListener("change",()=>{let O=parseInt(J.value,10);if(!isNaN(O))W?.setRate(O),document.cookie=`zmEventRate=${O};path=/;max-age=3600`})}function p(){let q=document.getElementById("progressBar");if(!q)return;q.addEventListener("click",(z)=>{let J=q.getBoundingClientRect(),U=(z.clientX-J.left)/J.width*100;W?.seekPercent(U)})}function S(){let q=document.getElementById("eventVideo"),z=document.getElementById("FullscreenBtn"),J=document.getElementById("EnterFsIcon"),O=document.getElementById("ExitFsIcon");if(!q||!z)return;z.addEventListener("click",async()=>{try{if(document.fullscreenElement)await document.exitFullscreen();else await q.requestFullscreen()}catch(U){console.error("[event] Fullscreen error:",U)}}),document.addEventListener("fullscreenchange",()=>{let U=!!document.fullscreenElement;J?.classList.toggle("hidden",U),O?.classList.toggle("hidden",!U)})}function j(q,z){let J=document.getElementById(q);if(J)J.textContent=z}export{m as init};
